```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(modelr)

knitr::opts_chunk$set(
  fig.width = 5,
  out.width = "60%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# in this part, we wanna see whether the crime numbers are different from month to month across the years...

```{r}
data <- read_csv("data/full_filter_data.csv")

# is there any difference between case number in every months across years?
month_data <- data %>%  
  group_by(year, month) %>% 
  summarise(number = n()) %>% 
  mutate(month = as.factor(month),
         year = as.factor(year))

aov_model <- aov(number ~ month, data = month_data)

summary(aov_model)

aov_posthoc <- TukeyHSD(aov_model, conf.level = .95) %>% 
  broom::tidy() %>% 
  filter(adj.p.value < 0.05) %>% 
  arrange(adj.p.value) %>% 
  separate(contrast, sep = "-", into = c("A", "B"))

# plot of case numbers of every month
month_data %>% 
  ggplot(aes(x = month, y = number, fill = month)) +
  geom_boxplot() +
  guides(fill = "none") 
```

```{r}
# Is there differnece between case numbers in every hour? 
hour_data = data %>% 
  group_by(year, month, hour) %>% 
  summarise(number = n()) %>%
  mutate(hour = as.factor(hour),
    hour = fct_inseq(hour)) 

aov_hour <- aov(number ~ hour, data = hour_data)

summary(aov_hour)

hour_data %>% 
  ggplot(aes(x = hour, y = number, fill = hour)) +
  geom_boxplot() +
  guides(fill = "none") 

# moreover we wanna see the pattern of different levels of crime

level_hour <- data %>% 
  group_by(year, month, hour, level) %>% 
  summarise(number = n()) %>%
  mutate(hour = as.factor(hour),
    hour = fct_inseq(hour))

level_hour_plot <- level_hour %>% 
  mutate(level = as.factor(level)) %>% 
  ggplot(aes(x = hour, y = number, fill = level)) +
  geom_boxplot()+
  ylim(0,120)

# which day, across years, has the most cases?

data %>% 
  group_by(month, day) %>% 
  summarise(number = n()) %>% 
  arrange(desc(number))

data %>% 
  group_by(month, day) %>% 
  summarise(number = n()) %>% 
  arrange((number))
```

It may be conuter-intuitive that more cases are happened in the afternoon-evening, rather than in the night.

Some impressive findings: the day having the most cases is new year's day, and then, children's day. The least is ..Christmas days.

```{r}
# where the cases most likely to happen?
data %>% 
  group_by(location) %>% 
  summarise(number = n()) %>% 
  arrange(desc(number))
```

## Build a linear model for prediction
```{r}



lm_data <- data %>% 
  filter(vic_age %in% c("<18", "18-24", "25-44", "45-64", "65+")) %>% 
  filter(vic_sex %in% c("M", "F")) %>%
  filter(vic_race != "(null)") %>% 
  mutate_at(c("month", "hour", "vic_age", "vic_race", "vic_sex"), as.factor) %>% 
  group_by(month, hour, vic_age, vic_race, vic_sex) %>% 
  summarise(log_number = log(n())) 

lm_model <- lm(log_number ~ . , data = lm_data)

hist(lm_data$number)
MASS::boxcox(lm(lm_data$number ~ 1))
hist(log(lm_data$number))

summary(lm_model)

plot(lm_model)

cv_result =
  crossv_mc(lm_data, 100) %>% 
  mutate(model = map(train, ~lm(log_number ~ ., data =.x))) %>% 
  mutate(rmse = map2_dbl(model, test,
                         ~rmse(model = .x, data = .y)))
cv_result %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()


## what if we do not classify by hours... to make one sample point having more samples
lm_lessvar <- data %>% 
  filter(vic_age %in% c("<18", "18-24", "25-44", "45-64", "65+")) %>% 
  filter(vic_sex %in% c("M", "F")) %>%
  filter(vic_race != "(null)") %>% 
  mutate_at(c("month", "hour", "vic_age", "vic_race", "vic_sex"), as.factor) %>% 
  group_by(month, vic_age, vic_race, vic_sex) %>% 
  summarise(number = log(n())) 

lm_less <- lm(number ~ . , data = lm_lessvar)

cv_result =
  crossv_mc(lm_lessvar, 100) %>% 
  mutate(model = map(train, ~lm(number ~ ., data =.x))) %>% 
  mutate(rmse = map2_dbl(model, test,
                         ~rmse(model = .x, data = .y)))

cv_result %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()



```
The linear result is, to some extend, accurate because its R square is very high. But in the cross validation part, the error is a little bit high, as most of the days, the cases have fewer cases than the rmse... 
 
```{r}
# find that group by day, every day there are too few cases, not appropriate for prediction, so we choose to ignore the day variable
lm_day <- data %>% 
  filter(vic_age %in% c("<18", "18-24", "25-44", "45-64", "65+")) %>% 
  filter(vic_sex %in% c("M", "F")) %>% 
  mutate_at(c("month", "hour", "day", "vic_age", "vic_race", "vic_sex"), as.factor) %>% 
  group_by(month, day ,hour, vic_age, vic_race, vic_sex) %>% 
  summarise(number = n()) %>% 
  lm(number ~., data = .) 

```
